#pragma once

#include "types.h"
#include <random>
#include "chess.h"

namespace chess::zobrist
{

    // is added on white turns and not added on black turns
    // (xored after each move to achieve the same effect)
    constexpr key turnKey = 5484880438138384345ULL;

    // one key for (white short, white long, black short, black long)
    constexpr key castlingKeys[4] = {
        9944050495791861203ULL, 16482004454988976468ULL, 12609729480893439433ULL, 4341827067395564024ULL};

    constexpr key getCastlingKey(bool wShort, bool wLong, bool bShort, bool bLong)
    {
        key hash = 0;
        if (wShort)
            hash ^= castlingKeys[0];

        if (wLong)
            hash ^= castlingKeys[1];

        if (bShort)
            hash ^= castlingKeys[2];

        if (bLong)
            hash ^= castlingKeys[3];

        return hash;
    }

    // one key for each posible enpassent location.
    constexpr key enpassentKeys[16] = {
        820780613328344538ULL, 4083571997848450089ULL, 6221262345041235126ULL, 10232829456158169025ULL, 16445135856452496350ULL, 511275075216867610ULL, 727349729957246488ULL, 5419799643380777782ULL, 6554712368888049859ULL, 11479100768183865066ULL, 14216333180453474149ULL, 17523577808220095814ULL, 8305895908845723755ULL, 9810163862867069593ULL, 11069082306939437973ULL, 17545855533653593832ULL};

    constexpr key getEnpassentKey(square enpassentSquare)
    {
        // Normalize the enpassentsquare to be 0-16
        return enpassentSquare == UINT8_MAX
                   ? 0
               : enpassentSquare < 32 ? enpassentKeys[enpassentSquare - 16]
                                      : enpassentKeys[enpassentSquare - 40];
    }

    // One key for every piece type (0-5) white pieces (6-11) black pieces
    constexpr key squarePieceKeys[64][12] = {
        {17473339210090333472ULL, 963351229459618018ULL, 17972999874122035550ULL, 17445978100525441934ULL, 3424598034760630375ULL, 17501041738393646817ULL, 16279945640074911137ULL, 17415158018893793717ULL, 1649615795561415205ULL, 13845102127332409295ULL, 17496705714794536028ULL, 2069035713200665240ULL}, {8871157307262897404ULL, 18010381762270286752ULL, 2315020831153858579ULL, 14121029655121660490ULL, 661488147954723357ULL, 1295624260895230660ULL, 3877112097116419589ULL, 12204377848753929736ULL, 3710343436193324518ULL, 18215933172888717644ULL, 5507059908094223963ULL, 16546295066399793518ULL}, {1497777014250538374ULL, 12178798506018618487ULL, 11591654747507480471ULL, 360853963238148465ULL, 3814630537960989761ULL, 14938049398733211700ULL, 14389486266320655058ULL, 283928504707405163ULL, 10602247774971510472ULL, 12085263740163030067ULL, 9881917994111401332ULL, 7376889730332940689ULL}, {6579879670702943089ULL, 13528349712230689295ULL, 10690111995501243516ULL, 15337627047573038909ULL, 4166003183117082232ULL, 14001864076961934291ULL, 17718771780736922526ULL, 16281923567800182268ULL, 6048553704042272914ULL, 6480679114385539143ULL, 5989901491589380287ULL, 963986964888596074ULL}, {12953238442664244673ULL, 16393272404512679006ULL, 16837597563662689793ULL, 12936143330437359466ULL, 321716851206636769ULL, 13435104165748809192ULL, 2933162990436699746ULL, 4517087972158114211ULL, 5650360910695712988ULL, 1922385549693307294ULL, 3813437577211512186ULL, 15689203148098563716ULL}, {10840432038224597251ULL, 10769927254796169273ULL, 11994506959614677454ULL, 7784248649917240510ULL, 13003329656615179079ULL, 1316068865480732836ULL, 18008417550077448618ULL, 8683860037540272122ULL, 17646291439311741236ULL, 1086476304032669609ULL, 7415704424211874134ULL, 5127425702610710950ULL}, {3728505849753018441ULL, 5541129906589952867ULL, 17159189914352194494ULL, 5931138854870734305ULL, 122184463353033097ULL, 11567357662023545567ULL, 164788206647650214ULL, 7307029407294213841ULL, 10161374150759723323ULL, 8992388777914161315ULL, 13302152435600483850ULL, 12633323325864114083ULL}, {6127753132698838856ULL, 11701881657086102328ULL, 16058436127377588774ULL, 7458835332599119062ULL, 2278837631089740698ULL, 8114277124886630382ULL, 8440144998691575714ULL, 7482489324844580058ULL, 1990906797197097611ULL, 13943914345759489829ULL, 17526829310719542960ULL, 3192613379342165412ULL}, {2820869479456222873ULL, 16877907702613155672ULL, 12561406624592089785ULL, 5996901309031294864ULL, 10977054854453459510ULL, 16234309949660744109ULL, 17414956989481964560ULL, 6673008047938194642ULL, 5480343037839595540ULL, 3154230231208740054ULL, 15495205016841521877ULL, 6006458127373454607ULL}, {12346117860538109732ULL, 5068952953661444644ULL, 7807373396406658689ULL, 2661366629619848689ULL, 14011467365477354592ULL, 9816591106753821093ULL, 3712745342818712124ULL, 18338612547080431341ULL, 8030614030679631073ULL, 392646033485429702ULL, 13736277234247266080ULL, 1693997871832970006ULL}, {13884764267389969943ULL, 11569096949115734172ULL, 12246792699584935744ULL, 3398368511842925293ULL, 5345474454997969945ULL, 10120593724456497533ULL, 10831376409205679411ULL, 4435770009226182173ULL, 4132013119953929803ULL, 10370161003944651597ULL, 10114099022935130277ULL, 16279532183509756397ULL}, {5736116476367634405ULL, 4698384841509082194ULL, 12780024426706710107ULL, 1999398068588461675ULL, 6992664236099088977ULL, 5837710363195103774ULL, 15940429658390880707ULL, 2611946069031588282ULL, 8464639843730000871ULL, 17717404255517096563ULL, 9193885333241516702ULL, 16097705371973489706ULL}, {777289342854338847ULL, 15074040894779551692ULL, 6519624666320853171ULL, 13916266899071650176ULL, 14139779297653906411ULL, 7741141128964279552ULL, 2089052816850634511ULL, 7444988018427394856ULL, 13017209872908583297ULL, 10572758623001512973ULL, 1828440053810209002ULL, 18309665577439665825ULL}, {6841092786955055642ULL, 11301013628982116723ULL, 16471451662269002313ULL, 10335665097621992382ULL, 8681584718369571161ULL, 507360486020985668ULL, 7896241151789122734ULL, 12360053256025106394ULL, 8901952803586758996ULL, 4714387686700745608ULL, 8088341981406686291ULL, 5826021335823119044ULL}, {1726532343427412576ULL, 500234024351897634ULL, 1832110534994026732ULL, 2187007479607996633ULL, 14608044515431096530ULL, 1228368815407325980ULL, 15819018628631781059ULL, 16407274727055329097ULL, 9486605066645705571ULL, 7213091314323378168ULL, 6880322142612533503ULL, 11212848544718360157ULL}, {15052394581612340019ULL, 5316571298151530ULL, 7017761785689768269ULL, 2314627502476281879ULL, 16572993202915328630ULL, 12593401046836683674ULL, 63620806630226082ULL, 16273720998152057890ULL, 10302117119025726285ULL, 13888914199679598598ULL, 12770554154298390393ULL, 15863413752978752268ULL}, {2474489535286573259ULL, 8713369339999335521ULL, 8069102009291900444ULL, 15364055764656216627ULL, 1907426226792276750ULL, 8359560920882644106ULL, 3566129384061759444ULL, 10070228719311567576ULL, 17302515664466826255ULL, 15355320176630790457ULL, 734813256622348172ULL, 6328936115674318699ULL}, {8257497126419715951ULL, 13198886031022198398ULL, 1245110248242479719ULL, 2130462331569022085ULL, 3771785576167743730ULL, 9476318280918478942ULL, 5947249949738155062ULL, 16145484478144014556ULL, 16885969718334033294ULL, 10906321862136745822ULL, 6860297094073876716ULL, 13412913000886690165ULL}, {13704215515873234344ULL, 15437624910761351786ULL, 17747139784245286402ULL, 13944489558484179299ULL, 14706413649773327192ULL, 4826607979836530503ULL, 1438822631142996782ULL, 14376079785754948247ULL, 1806074373047048335ULL, 17720283497205499442ULL, 16067474178109359321ULL, 11620226184360305944ULL}, {6754441343301951211ULL, 3337967447970702196ULL, 7215773209752154904ULL, 13435832938513027498ULL, 16508007280492694855ULL, 8194490064735959891ULL, 8039756703240398507ULL, 6449390554900642585ULL, 11692335664837979569ULL, 2664728805073176555ULL, 1393528916249364999ULL, 9221878831233753283ULL}, {9634212262163544242ULL, 14995331173461151683ULL, 9930157458030163707ULL, 7718890853253518937ULL, 445121920617099200ULL, 14772543369467444402ULL, 5293445576788659946ULL, 10189728149119135213ULL, 7263251332481106348ULL, 9945838212349758306ULL, 18198157261170612237ULL, 16263425409414402069ULL}, {10351711243516579756ULL, 10192614073164300131ULL, 1950896837003797841ULL, 8672245125238860448ULL, 6548811358950848172ULL, 2468122525784869525ULL, 17371575894946942435ULL, 7815669074423832766ULL, 13458986038812405998ULL, 17711738174680638104ULL, 3266453426534955224ULL, 6281722766044637147ULL}, {18198822743096918171ULL, 17015932546136480981ULL, 14267196592843540512ULL, 13021254507156217892ULL, 7595840185030543616ULL, 16980067644016915087ULL, 3995624634106285692ULL, 11495849627604412330ULL, 14504347671520021305ULL, 77532735189280487ULL, 4333347372737815446ULL, 15418935666023797766ULL}, {5303910904930328213ULL, 8907954762594109673ULL, 13474440367405132201ULL, 9907038654346657607ULL, 1264391211599593366ULL, 7331950058690044630ULL, 16925910843363139826ULL, 11164622320217881008ULL, 14088523140349325806ULL, 14508306763826607405ULL, 2712267340267015788ULL, 17408755353615947149ULL}, {384106176243778758ULL, 3333419611566818445ULL, 6986062139453100810ULL, 7693478498446427748ULL, 16324485597345358089ULL, 3886423138372867439ULL, 8402281457253241682ULL, 16902261002978885348ULL, 16345395390118308237ULL, 9406187775860787643ULL, 12422092843089329908ULL, 1259399293202040233ULL}, {9406816920473602774ULL, 9335703923086643324ULL, 7136598055666667233ULL, 13377852772034331252ULL, 910592861959409726ULL, 8941079392609378113ULL, 1054604679815031510ULL, 235250606783297260ULL, 16946953509918619478ULL, 11325278797007216622ULL, 1726619052774468714ULL, 10707503280236639261ULL}, {11555013408593226533ULL, 6781052136035754511ULL, 8228775072771113593ULL, 11600384313213770487ULL, 1027705300157945796ULL, 6098865479342670383ULL, 3191141203941999216ULL, 12071704997350054559ULL, 17998959715400768709ULL, 16896611252016864093ULL, 2692709867743082257ULL, 4451895541555617865ULL}, {16315468393998451114ULL, 15052041839949671526ULL, 973431484496800786ULL, 792136922411425219ULL, 9654685795553875702ULL, 1405475878262502168ULL, 5595983178952593888ULL, 13067890234120837854ULL, 18329285777446718753ULL, 5373111131407118863ULL, 16659146967217716583ULL, 13343680571762938508ULL}, {13384196237120478449ULL, 12671273942246568472ULL, 868240675933098538ULL, 17908483730221877863ULL, 18388447329250992889ULL, 2710540096135565821ULL, 17452068868930497885ULL, 2179783588474154460ULL, 11061833733654420520ULL, 3976824187418039315ULL, 17983050783693411553ULL, 17775129259869117297ULL}, {12704073011568025034ULL, 317777657403827305ULL, 2164081246216581463ULL, 5616066482846756043ULL, 4380379712467079392ULL, 2766159352785564488ULL, 14836321178464548214ULL, 6078546258920992565ULL, 7805228801307928440ULL, 13885179686369144512ULL, 16324722351323925275ULL, 9727872885296996461ULL}, {13310942691064085087ULL, 11327778345914507762ULL, 2418569921644849246ULL, 13622465729588936033ULL, 15993797583706598110ULL, 12577728522852669920ULL, 5107771183969100395ULL, 2125601229203083840ULL, 6055008981260839914ULL, 2876275045397778147ULL, 11400634585745693409ULL, 1445288722082820919ULL}, {2590048921064744733ULL, 4669094818332114156ULL, 13737270480760544187ULL, 5358356061228326124ULL, 4497048251865991095ULL, 4909467180719504812ULL, 2476890903406952944ULL, 4218161861898115664ULL, 13370921486783528865ULL, 16093888330147073394ULL, 1610692955792783429ULL, 6753465744315683571ULL}, {1546304724486337979ULL, 12494215826679589130ULL, 973511234813129419ULL, 1680818702644939400ULL, 13478690533275605367ULL, 10724023942805262208ULL, 3959710847685128273ULL, 11175455615862659764ULL, 13497252903338163928ULL, 2645336800653572798ULL, 8042688573010601344ULL, 11368804789350487349ULL}, {14547973709314165163ULL, 9367086790051093148ULL, 11821880785887762956ULL, 12232209822368566143ULL, 10321044467757282428ULL, 14384244679149922955ULL, 14964795471571594416ULL, 6902714633721554363ULL, 13670101078582211110ULL, 15200436164699423255ULL, 10469515780956767123ULL, 3304279193269889194ULL}, {5851901595498347248ULL, 10449456103109385078ULL, 15074452317288965457ULL, 6969771305030016ULL, 17861446448902959657ULL, 9731577908322059631ULL, 4906226529597198292ULL, 1386270913302730103ULL, 10616945541633601253ULL, 1169160021701654718ULL, 11609673240504831720ULL, 11133967539287068855ULL}, {8126480707464149241ULL, 14959623498774655889ULL, 1336726616759002614ULL, 13562879974818770409ULL, 8873130524142725567ULL, 8280417055041055899ULL, 10937551561254294478ULL, 11041370267722200755ULL, 4033399432821723381ULL, 5021835862778149770ULL, 9028035328895354865ULL, 11408750579025435461ULL}, {18394872478841579856ULL, 14698219875616946299ULL, 15192774155980788984ULL, 2064579665796590697ULL, 12893496510005948778ULL, 5652820798884354136ULL, 1687850857949897544ULL, 10362053059395455130ULL, 15538886183809257372ULL, 13737574638634377842ULL, 5103414921314362596ULL, 17601643553491998774ULL}, {15554789696366068152ULL, 9594378300308381123ULL, 15190049064387364318ULL, 16683164233147219927ULL, 895427137588006291ULL, 7266367540124879432ULL, 8068267097934632914ULL, 10382528063707980897ULL, 5377737192367217866ULL, 16951370916589348284ULL, 7947995635737611072ULL, 16305429582027778279ULL}, {15618508290959548788ULL, 2115201142445860701ULL, 1970308532177132508ULL, 15412024330527661556ULL, 12637312912311315000ULL, 158836885259240077ULL, 17454515936670929278ULL, 1504191924359254548ULL, 8097571804012641279ULL, 3410894126574581357ULL, 5139943844881278416ULL, 830413558483492396ULL}, {3737284206082364754ULL, 1732375262288301422ULL, 12238371032008392270ULL, 1578755366326639260ULL, 11742975378589297298ULL, 14193113349496554638ULL, 16552783445098144061ULL, 13348489302593278110ULL, 4976614702940004513ULL, 14682484662972174423ULL, 12228682161935915289ULL, 4131774885418049339ULL}, {15684037570884373663ULL, 13410193587443052369ULL, 12674321274914637565ULL, 6736625994447867620ULL, 5651437743746195665ULL, 10913480852040273257ULL, 732853595829209036ULL, 11305097747894215242ULL, 6711487542865683691ULL, 15837156321446628206ULL, 9451721300435154549ULL, 1736638851303892578ULL}, {11790644998196272806ULL, 6198650792795608873ULL, 17868860705628101296ULL, 15382095027429753607ULL, 404545056980279916ULL, 10066726011914186182ULL, 8129763731799780870ULL, 8062036954402849465ULL, 6667417203521289645ULL, 2711143911541366592ULL, 5447361515617169288ULL, 10350118279067286913ULL}, {72945013128658644ULL, 16720635612722509735ULL, 371464938653147938ULL, 10477073048695794307ULL, 8914855342965091471ULL, 2822103894848025826ULL, 3885092852988130415ULL, 11790046677772030462ULL, 7815638150231566559ULL, 13952562177300108374ULL, 6930495802852654843ULL, 3548092059431242137ULL}, {8916288195332824553ULL, 11868735661623761858ULL, 3090148511519513850ULL, 6802948325806174334ULL, 8745436387551627839ULL, 17474414108938149649ULL, 14875281907048419406ULL, 625907557682263312ULL, 10342370764198516749ULL, 13884708019163477914ULL, 3520032434089388198ULL, 13825489456171306511ULL}, {4871890037291892709ULL, 3457448360112203484ULL, 2145279264614251384ULL, 11221259583393771136ULL, 6416261174820731317ULL, 15877534968056306672ULL, 9748683353457993757ULL, 16365818711275306867ULL, 3117274259286998245ULL, 13356959994357990174ULL, 3543876526180220780ULL, 1721582712453317563ULL}, {5433183227705418394ULL, 11162786103072359495ULL, 5435479633049774552ULL, 17235677694890212955ULL, 7337374867792084845ULL, 12927196407643711941ULL, 15037406350904744349ULL, 14632325805998124982ULL, 9533489952265740776ULL, 15248410258639322967ULL, 3498100906158914362ULL, 18044771160635466125ULL}, {16344380918607114226ULL, 11752898338367867547ULL, 17681669198537968837ULL, 13038118101458766796ULL, 14017994377827459754ULL, 16055795903033821812ULL, 5462198754106532377ULL, 16132224713058010639ULL, 11388295226256688708ULL, 12362542141384344006ULL, 8728461741367187277ULL, 2857577376944877751ULL}, {2475536847563570230ULL, 18420563488043670523ULL, 157644007362806885ULL, 5872533487465669097ULL, 17077400088354480888ULL, 11639495852364010774ULL, 9008036365117124490ULL, 11255992941206541224ULL, 14259543624099475231ULL, 12293072792591170507ULL, 15286601651730467136ULL, 12421111230721624273ULL}, {11311460063124707429ULL, 13929361870912492688ULL, 3700212606454672612ULL, 3506782844906992235ULL, 5382468685930125798ULL, 6889216511755456708ULL, 2728623662614174186ULL, 16941576304379838167ULL, 7610063083806090928ULL, 11239987258944184285ULL, 9193506188915148173ULL, 10753632906706315480ULL}, {843970411532774100ULL, 8226662297395733188ULL, 12962511019465690946ULL, 15170714483822116123ULL, 11938719455050828916ULL, 7618679454165230633ULL, 7698840819852201287ULL, 3771931973834526014ULL, 9087358389251761708ULL, 7445479793030000403ULL, 17556757621837338506ULL, 9719041538676127307ULL}, {2590720774910526594ULL, 17685857736059500263ULL, 17917984097894544562ULL, 18059255653062086094ULL, 2892672256053330717ULL, 11866264154985049255ULL, 7296656658601254831ULL, 12374546616134360735ULL, 15482179687294081260ULL, 4407079315326170722ULL, 8769474546779136606ULL, 12617093807705978132ULL}, {13719802744610220270ULL, 7900410453184761060ULL, 401366561803324504ULL, 17400200075302667100ULL, 15988014054193050789ULL, 15599627519709088292ULL, 15287733325440923526ULL, 12579594433153308893ULL, 17836759567271284184ULL, 14072492476773252209ULL, 14185180899713056624ULL, 5259984292890298753ULL}, {17444546720882228326ULL, 482458442486807400ULL, 15359764684562136149ULL, 5318670972946783874ULL, 11208277711566719799ULL, 2017112110607260193ULL, 8109349184932594945ULL, 5818943694598239516ULL, 13468364838905801031ULL, 8570211671617338844ULL, 6642605316401579699ULL, 5336362636927131162ULL}, {7130407113685503484ULL, 10461616878625749124ULL, 8187254699442278593ULL, 16106017330747167305ULL, 16914342438276750524ULL, 17357904369844371002ULL, 5624529723888100677ULL, 3183315679762701781ULL, 14159151739944249872ULL, 11488885571952859754ULL, 9166811605978531442ULL, 3185371559640935025ULL}, {4582671368653463077ULL, 8890160725412272678ULL, 2315880696574347295ULL, 9935075972688495130ULL, 6347533043377475094ULL, 378000956070006555ULL, 14177737564571280860ULL, 806582311316563290ULL, 17265589183593605431ULL, 2509005520710824965ULL, 16168960475727723159ULL, 1651516025915254236ULL}, {8981624962864557402ULL, 1944835474145489279ULL, 14017921345340024211ULL, 17589457229592878247ULL, 17291946287009317911ULL, 7230117917809502068ULL, 5205399309367609891ULL, 15366680318944002561ULL, 10983796247802850891ULL, 1663372864833111837ULL, 11435995085460597570ULL, 17987437170996817954ULL}, {2032944085478678395ULL, 3359599257201539471ULL, 6099562321312056769ULL, 9513200639823773788ULL, 7860929546548109555ULL, 14437943310841011460ULL, 12469815497068946266ULL, 14586902530887809788ULL, 13540240725945911509ULL, 9654781800613065660ULL, 12526471145669906435ULL, 11956749577981178985ULL}, {18088769676466943511ULL, 118844582745427994ULL, 6354352520585366782ULL, 1623919673978275037ULL, 1629376961100642998ULL, 17502019121699842481ULL, 3223592379696491341ULL, 16665363532426450001ULL, 3718120846282594922ULL, 14496983126259681887ULL, 4985288653879607034ULL, 17814448690673251255ULL}, {16864468683994746534ULL, 4185470309801231717ULL, 5857190669607815119ULL, 11908353138135750870ULL, 2941025266556677238ULL, 10431438376549027851ULL, 17083546050215480717ULL, 261119689931957096ULL, 4996610854740980886ULL, 674003830629938248ULL, 13908506201851025250ULL, 10930462477135429198ULL}, {6146579892137472614ULL, 11647167080722829830ULL, 668563770989016065ULL, 8357704892160856033ULL, 13376172051070190439ULL, 4207898403975625ULL, 17900798646393480034ULL, 10300936135930789216ULL, 15501076157324811895ULL, 1612166810363601998ULL, 13532975285322549582ULL, 2273215620439587241ULL}, {1746103969914786006ULL, 7801490520086467506ULL, 10793492359814088475ULL, 10112113924605681070ULL, 18075208726100214204ULL, 7367833699206786349ULL, 1090316805157090978ULL, 1837399161823961919ULL, 13617063569341239539ULL, 15218066275913056610ULL, 3502067856511536801ULL, 12038771957408847259ULL}, {16814777630005438928ULL, 14305723377735834381ULL, 15707556627301032701ULL, 8797790302129636145ULL, 9941263945964341531ULL, 13652466116981450989ULL, 1243597255419177450ULL, 1337321328368951401ULL, 8813544999411445268ULL, 11472171759239927330ULL, 10647919170606808657ULL, 13604741032369686464ULL}, {5078794290247176197ULL, 1816743944863995666ULL, 6394511408598076028ULL, 5097260411060862011ULL, 13784258096880035820ULL, 1869660556566260731ULL, 12878472044270450319ULL, 7874821379286253639ULL, 348952044248792994ULL, 4486046044678957812ULL, 6250399382753975908ULL, 9944704648193586306ULL}, {13628241501910582984ULL, 16631341983176075784ULL, 7068241439955073563ULL, 2557776218921742128ULL, 14048798672305763252ULL, 3397315299658290332ULL, 4468628347018645727ULL, 8396777390054458061ULL, 14403912293234306354ULL, 15054789924682287466ULL, 6532037455070474776ULL, 3132497969735809240ULL}};

    constexpr key getPieceKey(square s, PieceType pt, bool white)
    {
        return squarePieceKeys[s][pt + (white ? 0 : 6)];
    }
}